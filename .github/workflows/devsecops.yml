name: DevSecOps CI/CD Pipeline

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  # =========================================
  # 1. TESTS – Paralelo por servicio
  # =========================================
  test-users-service:
    runs-on: [self-hosted, Linux, X64]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Create env file
        run: cp backend/users-service/.env.example backend/users-service/.env
      - name: Install & Test
        run: |
          cd backend/users-service
          npm ci
          npm test

  test-academic-service:
    runs-on: [self-hosted, Linux, X64]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Create env file
        run: cp backend/academic-service/.env.example backend/academic-service/.env
      - name: Install & Test
        run: |
          cd backend/academic-service
          npm ci
          npm test

  test-api-gateway:
    runs-on: [self-hosted, Linux, X64]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Create env file
        run: cp backend/api-gateway/.env.example backend/api-gateway/.env
      - name: Install & Test
        run: |
          cd backend/api-gateway
          npm ci
          npm test

  test-frontend:
    runs-on: [self-hosted, Linux, X64]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Create env file
        run: cp frontend/.env.example frontend/.env
      - name: Install & Test
        run: |
          cd frontend
          npm ci
          npm test

  # =========================================
  # 2. SAST – Semgrep en paralelo (matrix)
  # =========================================
  sast:
    needs:
      - test-users-service
      - test-academic-service
      - test-api-gateway
      - test-frontend
    runs-on: [self-hosted, Linux, X64]
    strategy:
      matrix:
        service: [users-service, academic-service, api-gateway]
    steps:
      - uses: actions/checkout@v4
      - name: Setup venv
        run: |
          python3 -m venv venv
          source venv/bin/activate
          python -m ensurepip --upgrade
          pip install --upgrade pip
          pip install semgrep
      - name: SAST – ${{ matrix.service }}
        run: |
          source venv/bin/activate
          cd backend/${{ matrix.service }}
          semgrep scan --config auto

  # =========================================
  # 3. SAST – SonarQube en paralelo (matrix)
  # =========================================
  sonarqube:
    needs:
      - test-users-service
      - test-academic-service
      - test-api-gateway
      - test-frontend
    runs-on: [self-hosted, Linux, X64]
    strategy:
      matrix:
        include:
          - service: users-service
            dir: backend/users-service
          - service: academic-service
            dir: backend/academic-service
          - service: api-gateway
            dir: backend/api-gateway
          - service: frontend
            dir: frontend
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0   # necesario para análisis de historial en SonarQube

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Instalar dependencias y generar cobertura
        run: |
          cp ${{ matrix.dir }}/.env.example ${{ matrix.dir }}/.env 2>/dev/null || true
          cd ${{ matrix.dir }}
          npm ci
          npm test -- --coverage --coverageReporters=lcov 2>/dev/null || npm test

      - name: SonarQube Scan – ${{ matrix.service }}
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          projectBaseDir: ${{ matrix.dir }}

  # =========================================
  # 4. DOCKER BUILD
  # =========================================
  docker-build:
    needs:
      - sast
      - sonarqube
    runs-on: [self-hosted, Linux, X64]
    steps:
      - uses: actions/checkout@v4

      - name: Create env files
        run: |
          cp backend/users-service/.env.example  backend/users-service/.env
          cp backend/academic-service/.env.example backend/academic-service/.env
          cp backend/api-gateway/.env.example     backend/api-gateway/.env
          cp frontend/.env.example                frontend/.env

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker images
        run: docker compose -f backend/docker-compose.yml build

  # =========================================
  # 5. SCA – Trivy en paralelo (matrix)
  # =========================================
  trivy:
    needs: docker-build
    runs-on: [self-hosted, Linux, X64]
    strategy:
      matrix:
        image: [users-service, academic-service, api-gateway, frontend]
    steps:
      - name: Trivy scan – ${{ matrix.image }}
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: ${{ matrix.image }}
          severity: CRITICAL
          exit-code: 1
          vuln-type: os,library
          format: table

  # =========================================
  # 6. SMOKE TESTS
  # =========================================
  smoke-tests:
    needs: trivy
    runs-on: [self-hosted, Linux, X64]
    steps:
      - uses: actions/checkout@v4

      - name: Create env files
        run: |
          cp backend/users-service/.env.example  backend/users-service/.env
          cp backend/academic-service/.env.example backend/academic-service/.env
          cp backend/api-gateway/.env.example     backend/api-gateway/.env

      - name: Run docker-compose
        run: |
          docker compose -f backend/docker-compose.yml up -d --no-build
          sleep 20

      - name: Smoke test – API Gateway health
        run: |
          curl -sf http://localhost:3000/health | grep -q "api-gateway OK"
          echo "API Gateway OK"

      - name: Smoke test – Login (users-service via gateway)
        run: |
          RESPONSE=$(curl -sf -X POST http://localhost:3000/auth/login \
            -H "Content-Type: application/json" \
            -d '{"email":"admin@test.cl","password":"123456"}')
          echo "$RESPONSE" | grep -q "token"
          echo "Login OK – JWT recibido"

      - name: Smoke test – Courses (academic-service via gateway)
        run: |
          TOKEN=$(curl -sf -X POST http://localhost:3000/auth/login \
            -H "Content-Type: application/json" \
            -d '{"email":"admin@test.cl","password":"123456"}' \
            | grep -o '"token":"[^"]*"' | cut -d'"' -f4)
          curl -sf http://localhost:3000/courses \
            -H "Authorization: Bearer $TOKEN" | grep -q "DevSecOps"
          echo "Courses OK"

      - name: Shutdown services
        if: always()
        run: docker compose -f backend/docker-compose.yml down || true

  # =========================================
  # 7. PUBLISH – Docker Hub + Cleanup
  # =========================================
  publish:
    needs: smoke-tests
    runs-on: [self-hosted, Linux, X64]
    env:
      REGISTRY: luisfer34/devsecops-ucb
      SHA: ${{ github.sha }}
    steps:
      - name: Login a Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Tag y push – users-service
        run: |
          docker tag users-service $REGISTRY:users-service-${SHA::7}
          docker tag users-service $REGISTRY:users-service-latest
          docker push $REGISTRY:users-service-${SHA::7}
          docker push $REGISTRY:users-service-latest

      - name: Tag y push – academic-service
        run: |
          docker tag academic-service $REGISTRY:academic-service-${SHA::7}
          docker tag academic-service $REGISTRY:academic-service-latest
          docker push $REGISTRY:academic-service-${SHA::7}
          docker push $REGISTRY:academic-service-latest

      - name: Tag y push – api-gateway
        run: |
          docker tag api-gateway $REGISTRY:api-gateway-${SHA::7}
          docker tag api-gateway $REGISTRY:api-gateway-latest
          docker push $REGISTRY:api-gateway-${SHA::7}
          docker push $REGISTRY:api-gateway-latest

      - name: Tag y push – frontend
        run: |
          docker tag frontend $REGISTRY:frontend-${SHA::7}
          docker tag frontend $REGISTRY:frontend-latest
          docker push $REGISTRY:frontend-${SHA::7}
          docker push $REGISTRY:frontend-latest

      - name: Limpiar imágenes del proyecto
        if: always()
        run: |
          # Solo elimina las imágenes de este proyecto, no afecta otros servicios del servidor
          docker rmi users-service    2>/dev/null || true
          docker rmi academic-service 2>/dev/null || true
          docker rmi api-gateway      2>/dev/null || true
          docker rmi frontend         2>/dev/null || true
          docker rmi $REGISTRY:users-service-${SHA::7}    2>/dev/null || true
          docker rmi $REGISTRY:users-service-latest       2>/dev/null || true
          docker rmi $REGISTRY:academic-service-${SHA::7} 2>/dev/null || true
          docker rmi $REGISTRY:academic-service-latest    2>/dev/null || true
          docker rmi $REGISTRY:api-gateway-${SHA::7}      2>/dev/null || true
          docker rmi $REGISTRY:api-gateway-latest         2>/dev/null || true
          docker rmi $REGISTRY:frontend-${SHA::7}         2>/dev/null || true
          docker rmi $REGISTRY:frontend-latest            2>/dev/null || true